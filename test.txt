#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <dirent.h>
#include <unistd.h>
#include <termios.h>

#define ESC    "\033[0m"
#define ORANGE "\033[33m"

void redraw(char **f_list, int len, int target);

struct termios orig;

void enable_raw(void) {
    tcgetattr(STDIN_FILENO, &orig);
    struct termios raw = orig;
    raw.c_lflag &= ~(ECHO | ICANON);
    tcsetattr(STDIN_FILENO, TCSAFLUSH, &orig);
}

void disable_raw(void) {
    tcsetattr(STDIN_FILENO, TCSAFLUSH, &orig);
}

void input_monitor(char **f_list, int len, int target) {
    int index = 0;
    redraw(f_list, len, index);
    while (1) {
        char c;
        if (read(STDIN_FILENO, &c, 1) <= 0) {
            continue;
        }
        if (c == '\x1b') {
            char seq[5];
            int i = 0;
            do {
                seq[i++] = c;
                if (read(STDIN_FILENO, &c, 1) <= 0) break;
            } while (c != '$');
            switch(seq[1]) {
                case 'A':
                    printf("Стрелка вверх\n");
                    break;
                case 'B':
                    printf("Стрелка вниз\n");
                    break;
                case 'C':
                    printf("Стрелка вправо\n");
                    break;
                case 'D':
                    printf("Стрелка влево\n");
                    break;
            } 
        }
    }
}

void redraw(char **f_list, int len, int target) {
    if (target > len) {
        return;
    }
    for (int i = 0; i < len; i++) {
        if (i == target - 1) {
            printf(ORANGE "%s\n" ESC, f_list[i]);
        } else {
            printf("%s\n", f_list[i]);
        }
    }
    fflush(stdout);
}

int list(char *dir, char **f_list) {
    DIR *wdir = opendir(dir);
    if (!wdir) {
        fprintf(stderr, "Error wit opening dir\n");
        return 0;
    }
    int items_count = 0;
    struct dirent *ent;
    while ((ent = readdir(wdir)) != NULL) {
        if (strcmp(ent->d_name, ".") == 0 || strcmp(ent->d_name, "..") == 0) continue;
        f_list[items_count] = malloc(strlen(ent->d_name) + 1);
        strcpy(f_list[items_count++], ent->d_name);
    }
    closedir(wdir);
    return items_count;
}


int main() {
    char *f_list[100];
    int items_count = list(".", f_list);
    printf("Current dir: %d\n", items_count);
    enable_raw();
    while (1) {
        input_monitor(f_list, items_count, 11);
    }
    disable_raw();
    for (int i = 0; i < items_count; i++) {
        free(f_list[i]);
    }
    return 0;
}
